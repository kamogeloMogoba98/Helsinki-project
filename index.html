<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Helsinki Live Bus Map</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.5.2/ol.css">
<style>
  html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
  #map { width: 100%; height: 100%; }
  
  /* Search UI Styling */
  .search-container {
    position: absolute;
    top: 10px;
    left: 50px;
    z-index: 1000;
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    display: flex;
    gap: 5px;
  }
  input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; outline: none; }
  button { padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
  button:hover { background: #0056b3; }
  #clear-btn { background: #6c757d; }
</style>
</head>
<body>

<div class="search-container">
  <input type="text" id="busSearchInput" placeholder="Vehicle ID (e.g. 1234)">
  <button onclick="searchBus()">Track</button>
  <button id="clear-btn" onclick="clearSearch()">Clear</button>
</div>

<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/ol@7.5.2/dist/ol.js"></script>
<script>
const map = new ol.Map({
  target: 'map',
  layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
  view: new ol.View({
    center: ol.proj.fromLonLat([24.9384, 60.1695]), // Helsinki
    zoom: 12
  })
});

const busSource = new ol.source.Vector();
const busLayer = new ol.layer.Vector({ source: busSource });
map.addLayer(busLayer);

const buses = {};      // vehicle_id -> feature
const busHistory = {}; // vehicle_id -> [{coords, timestamp}]
let trackedVehicleId = null; // To keep track of search

function searchBus() {
    const val = document.getElementById('busSearchInput').value.trim();
    if (val) {
        trackedVehicleId = val;
    }
}

function clearSearch() {
    trackedVehicleId = null;
    document.getElementById('busSearchInput').value = "";
}

const evtSource = new EventSource("/stream");
evtSource.onmessage = function(event) {
  let data;
  try {
    let jsonStr = event.data.trim();
    if (jsonStr.startsWith("data:")) jsonStr = jsonStr.slice(5).trim();
    data = JSON.parse(jsonStr);
  } catch (e) {
    console.error("Error parsing SSE data:", e);
    return;
  }

  data.forEach(bus => {
    const id = bus.vehicle_id.toString(); // Ensure it's a string for comparison
    const coords = ol.proj.fromLonLat([bus.longitude, bus.latitude]);
    const timestamp = bus.timestamp;

    // Update or create live bus feature
    if (buses[id]) {
      buses[id].getGeometry().setCoordinates(coords);
    } else {
      const feature = new ol.Feature({ geometry: new ol.geom.Point(coords), id: id });
      feature.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
          radius: 7,
          fill: new ol.style.Fill({ color: '#1a73e8' }),
          stroke: new ol.style.Stroke({ color: 'white', width: 2 })
        }),
        text: new ol.style.Text({
          text: id,
          offsetY: -15,
          font: 'bold 11px sans-serif',
          fill: new ol.style.Fill({ color: '#000' }),
          stroke: new ol.style.Stroke({ color: '#fff', width: 2 })
        })
      }));
      busSource.addFeature(feature);
      buses[id] = feature;
      busHistory[id] = [];
    }

    // AUTO-ZOOM LOGIC: If this bus is the one we searched for
    if (trackedVehicleId && id === trackedVehicleId) {
        map.getView().animate({
            center: coords,
            duration: 800,
            zoom: 16
        });
    }

    // Store history
    const last = busHistory[id][0];
    if (!last || last.timestamp !== timestamp) {
      busHistory[id].unshift({ lon: bus.longitude, lat: bus.latitude, timestamp });
      if (busHistory[id].length > 100) busHistory[id].pop();
    }
  });
};

// ... (Your existing click handler for polylines)
map.on('click', function(evt) {
  map.forEachFeatureAtPixel(evt.pixel, function(feature) {
    const id = feature.get('id');
    if (!id) return;

    const coordsArr = busHistory[id].map(h => ol.proj.fromLonLat([h.lon, h.lat]));
    const polyline = new ol.Feature({
      geometry: new ol.geom.LineString(coordsArr)
    });
    const polyLayer = new ol.layer.Vector({
      source: new ol.source.Vector({ features: [polyline] }),
      style: new ol.style.Style({
        stroke: new ol.style.Stroke({ color: '#1a73e8', width: 4 })
      })
    });
    map.addLayer(polyLayer);
    setTimeout(() => map.removeLayer(polyLayer), 20000);
  });
});
</script>
</body>
</html>